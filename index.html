<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>图像增强对比选择（前台仅选择，统计在后台表格）</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Microsoft Yahei", sans-serif; }
    body { padding: 15px; max-width: 1200px; margin: 0 auto; background-color: #f5f5f5; }
    h1 { text-align: center; margin-bottom: 20px; color: #333; font-size: 22px; font-weight: 600; }
    h2 { color: #444; margin-top: 26px; margin-bottom: 12px; border-bottom: 1px solid #e0e0e0; padding-bottom: 8px; font-size: 18px; }

    .hint {
      margin: 10px 0 18px 0;
      padding: 12px 14px;
      background: #fff;
      border-radius: 8px;
      border-left: 4px solid #2196F3;
      color: #444;
      font-size: 13px;
      line-height: 1.6;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .image-row {
      display: flex;
      gap: 10px;
      margin-bottom: 18px;
      align-items: stretch;
      padding: 15px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      flex-wrap: wrap;
    }
    .image-col { flex: 1; min-width: 140px; text-align: center; }
    .image-item {
      border: 2px solid #cccccc;
      border-radius: 6px;
      padding: 8px;
      transition: all 0.2s ease;
      height: 100%;
      display: flex;
      flex-direction: column;
      background: #fff;
    }
    .image-item.option { cursor: pointer; }
    .image-item.option.selected {
      border-color: #2196F3;
      background-color: #f0f8ff;
      box-shadow: 0 0 6px rgba(33, 150, 243, 0.3);
    }
    .image-item.option:hover { border-color: #2196F3; }
    .image-item div { font-size: 12px; color: #666; margin-bottom: 8px; flex-shrink: 0; }
    .image-item img { width: 100%; height: auto; border-radius: 4px; object-fit: contain; flex-grow: 1; }

    .footer-bar{
      margin-top: 18px;
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap: wrap;
    }
    .btn {
      padding: 10px 18px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.2s;
      color: #fff;
    }
    .btn-reset { background-color: #dc3545; }
    .btn-reset:hover { background-color: #c82333; }

    .toast {
      position: fixed;
      left: 50%;
      bottom: 20px;
      transform: translateX(-50%);
      background: rgba(33,150,243,0.95);
      color: #fff;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 13px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.18);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
    }
    .toast.show { opacity: 1; }
  </style>
</head>

<body>
  <h1>图像增强对比选择</h1>

  <div class="hint">
    说明：每一行只需要在 A / B 中选择你认为更好的结果（可随时改选）。<br/>
    你的选择会自动提交到后台统计表中；本页面不展示统计结果。
  </div>

  <!-- 图像容器：动态生成三个部分的内容 -->
  <div id="image-container"></div>

  <div class="footer-bar">
    <button class="btn btn-reset" onclick="resetMySelections()">清除我的选择</button>
  </div>

  <div id="toast" class="toast">✅ 已记录</div>

  <script>
    /************************************************************
     *  1) 重要：把下面这个 URL 改成你 Apps Script 部署后的 Web App URL
     *     形如：https://script.google.com/macros/s/xxxx/exec
     ************************************************************/
    const ENDPOINT_URL = "https://script.google.com/macros/s/AKfycby-lgcJkXFIYczo9WCxBSTdLzQyF_BLDVTiMFWWOhsh4nQ84-ZX5diQ_hyhZ_0f-MsC/exec";

    // ===================== 新增：图像配置项 =====================
    // 定义3个部分的配置，每部分9行（3张/行×9行=27张），覆盖1_1到1_27、2_1到2_27、3_1到3_27
    const sectionsConfig = [
      {
        sectionId: 1,          // 部分编号
        title: "第一部分：室内低光图像", // 部分标题
        prefix: "1",           // 图像编号前缀（1_*.png）
        rowCount: 9            // 行数（9行=27张图）
      },
      {
        sectionId: 2,
        title: "第二部分：室外低光图像",
        prefix: "2",
        rowCount: 9
      },
      {
        sectionId: 3,
        title: "第三部分：混合场景低光图像", // 可自定义标题
        prefix: "3",
        rowCount: 9
      }
    ];

    // ===================== 新增：动态生成图像行 =====================
    function generateImageSections() {
      const container = document.getElementById('image-container');
      sectionsConfig.forEach(section => {
        // 1. 创建部分标题
        const sectionTitle = document.createElement('h2');
        sectionTitle.textContent = section.title;
        container.appendChild(sectionTitle);

        // 2. 循环生成当前部分的所有行（rowCount行）
        for (let row = 1; row <= section.rowCount; row++) {
          // 计算当前行的图像编号：低光图=3n-2，增强A=3n-1，增强B=3n
          const lowLightImg = `${section.prefix}_${3*row - 2}.png`;
          const enhanceAImg = `${section.prefix}_${3*row - 1}.png`;
          const enhanceBImg = `${section.prefix}_${3*row}.png`;

          // 3. 创建图像行容器
          const imageRow = document.createElement('div');
          imageRow.className = 'image-row';
          imageRow.dataset.row = row;
          imageRow.dataset.section = section.sectionId;

          // 4. 拼接图像行的HTML内容
          imageRow.innerHTML = `
            <div class="image-col">
              <div class="image-item">
                <div>低光图像</div>
                <img src="${lowLightImg}" alt="${section.title}低光${row}">
              </div>
            </div>
            <div class="image-col">
              <div class="image-item option" data-row="${row}" data-section="${section.sectionId}" data-type="A" data-img="${enhanceAImg}" onclick="recordClick(this)">
                <div>增强图像A</div>
                <img src="${enhanceAImg}" alt="${section.title}增强A${row}">
              </div>
            </div>
            <div class="image-col">
              <div class="image-item option" data-row="${row}" data-section="${section.sectionId}" data-type="B" data-img="${enhanceBImg}" onclick="recordClick(this)">
                <div>增强图像B</div>
                <img src="${enhanceBImg}" alt="${section.title}增强B${row}">
              </div>
            </div>
          `;

          // 5. 添加到容器
          container.appendChild(imageRow);
        }
      });
    }

    // 本地存储：保存“我自己的选择状态”（用于刷新页面仍保留高亮）
    const savedStats = localStorage.getItem('imageClickStats');
    // 核心数据结构：section=1/2/3，A/B=增强列，值 0/1（是否为该行最终选中）
    const clickStats = savedStats
      ? JSON.parse(savedStats)
      : { 1: { A: {}, B: {} }, 2: { A: {}, B: {} }, 3: { A: {}, B: {} } }; // 新增section3

    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg || '✅ 已记录';
      t.classList.add('show');
      clearTimeout(showToast._timer);
      showToast._timer = setTimeout(() => t.classList.remove('show'), 900);
    }

    // 生成/获取匿名参与者ID（保存在该参与者的浏览器中）
    function getPID() {
      const k = "pid";
      let pid = localStorage.getItem(k);
      if (!pid) {
        pid = (crypto?.randomUUID?.() || ("pid_" + Date.now() + "_" + Math.random().toString(16).slice(2)));
        localStorage.setItem(k, pid);
      }
      return pid;
    }

    // 上报到你的 Google Sheet（后台统计用）
    function sendVote(payload) {
      // 如果你忘了填 URL，这里直接跳过（页面仍可正常选择/高亮）
      if (!ENDPOINT_URL || ENDPOINT_URL.includes("请在这里粘贴")) return;

      // 用 no-cors，避免跨域问题；我们不读取返回值
      fetch(ENDPOINT_URL, {
        method: "POST",
        mode: "no-cors",
        body: JSON.stringify(payload)
      }).catch(err => {
        console.warn("sendVote failed:", err);
      });
    }

    // 初始化：给所有可选项补 0，并根据本地存储恢复高亮
    function initStats() {
      // 先动态生成图像行
      generateImageSections();

      // 再初始化统计数据和高亮
      document.querySelectorAll('.option').forEach(item => {
        const section = item.dataset.section;
        const type = item.dataset.type;
        const imgName = item.dataset.img;

        if (clickStats[section][type][imgName] === undefined) {
          clickStats[section][type][imgName] = 0;
        }
        if (clickStats[section][type][imgName] === 1) {
          item.classList.add('selected');
        }
      });

      // 立刻把补全后的结构保存一下（避免后续 undefined）
      localStorage.setItem('imageClickStats', JSON.stringify(clickStats));
    }

    /**
     * 核心点击：每行只保留最终选择 1 个
     * 逻辑：先把同一行的 A/B 全部置 0 + 去高亮；再把当前点击置 1 + 高亮
     * 然后：本地保存（高亮恢复） + 上报后台（你统计用）
     */
    function recordClick(currentEl) {
      const row = currentEl.dataset.row;
      const section = currentEl.dataset.section;
      const type = currentEl.dataset.type;
      const imgName = currentEl.dataset.img;

      // 1) 同一行所有可选项全部取消
      const rowAllOptions = document.querySelectorAll(`.option[data-row="${row}"][data-section="${section}"]`); // 新增section筛选，避免跨部分冲突
      rowAllOptions.forEach(option => {
        const optSection = option.dataset.section;
        const optType = option.dataset.type;
        const optImg = option.dataset.img;
        clickStats[optSection][optType][optImg] = 0;
        option.classList.remove('selected');
      });

      // 2) 当前项设为最终选择
      clickStats[section][type][imgName] = 1;
      currentEl.classList.add('selected');

      // 3) 保存本地（用于刷新后仍保留高亮）
      localStorage.setItem('imageClickStats', JSON.stringify(clickStats));

      // 4) 上报后台（你在 Google Sheet 看统计）
      sendVote({
        pid: getPID(),
        section: section,
        row: row,
        type: type,
        img: imgName
      });

      showToast("✅ 已记录");
    }

    // 清除“我自己的选择”（只影响本机浏览器，不影响后台统计）
    function resetMySelections() {
      document.querySelectorAll('.option').forEach(item => {
        const section = item.dataset.section;
        const type = item.dataset.type;
        const imgName = item.dataset.img;
        clickStats[section][type][imgName] = 0;
        item.classList.remove('selected');
      });
      localStorage.removeItem('imageClickStats');
      showToast("✅ 已清除本地选择");
    }

    // 页面加载后初始化
    window.onload = initStats;
  </script>
</body>
</html>